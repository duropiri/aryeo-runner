# =============================================================================
# Aryeo Delivery Runner - Production Docker Compose
# =============================================================================
# Usage:
#   docker-compose -f docker-compose.production.yml up -d
#
# Prerequisites:
#   1. Copy .env.production to .env and fill in values
#   2. Place aryeo-storage-state.json in ./data/auth/
#   3. Configure Cloudflare Tunnel (see deploy/cloudflared/)
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Redis - BullMQ Job Queue Backend
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: aryeo-redis
    restart: always
    # Do NOT expose Redis port in production (internal only)
    # ports:
    #   - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - runner-internal
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # ===========================================================================
  # API Server - Handles HTTP requests
  # ===========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: aryeo-delivery-runner:latest
    container_name: aryeo-api
    restart: always
    # Exposed to host for Cloudflare Tunnel / reverse proxy
    ports:
      - "127.0.0.1:8080:8080"
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - RUNNER_PORT=8080
      - REDIS_URL=redis://redis:6379
      - DATA_DIR=/app/data
      - TRUST_PROXY=true
    volumes:
      # Persistent data volume for evidence screenshots
      - runner-data:/app/data
      # Mount auth state from host (read-only for security)
      - ./data/auth/aryeo-storage-state.json:/app/data/auth/aryeo-storage-state.json:ro
    depends_on:
      redis:
        condition: service_healthy
    command: ["node", "dist/server.js"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - runner-internal
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # Worker - Processes BullMQ jobs with Playwright
  # ===========================================================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    image: aryeo-delivery-runner:latest
    container_name: aryeo-worker
    restart: always
    # No ports exposed - worker is internal only
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://redis:6379
      - PLAYWRIGHT_HEADLESS=true
      - DATA_DIR=/app/data
    volumes:
      # Persistent data volume for evidence screenshots
      - runner-data:/app/data
      # Mount auth state from host (read-only for security)
      - ./data/auth/aryeo-storage-state.json:/app/data/auth/aryeo-storage-state.json:ro
    depends_on:
      redis:
        condition: service_healthy
      api:
        condition: service_healthy
    command: ["node", "dist/worker.js"]
    # Worker doesn't have HTTP healthcheck, use process check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node dist/worker.js"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - runner-internal
    # Worker needs more resources for Playwright/Chromium
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
        reservations:
          memory: 1G
          cpus: '1'
    # Required for Playwright in Docker
    security_opt:
      - seccomp:unconfined
    # Share memory for Chromium
    shm_size: '1gb'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

# =============================================================================
# Networks
# =============================================================================
networks:
  runner-internal:
    driver: bridge
    internal: false  # Allow outbound internet access for callbacks

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis-data:
    driver: local
  runner-data:
    driver: local
